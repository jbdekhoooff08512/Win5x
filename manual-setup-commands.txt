# Win5x Server Clean Setup - Manual Commands
# Copy and paste these commands one by one

# Server Details
SERVER_IP="217.148.142.91"
SSH_PORT="6579"
SERVER_USER="root"
PROJECT_DIR="/var/www/win5x"

# Step 1: Connect to server
ssh -p $SSH_PORT $SERVER_USER@$SERVER_IP

# Step 2: Stop all PM2 processes
pm2 stop all
pm2 delete all

# Step 3: Clean old project directory
rm -rf $PROJECT_DIR
mkdir -p $PROJECT_DIR

# Step 4: Install required packages
apt update
apt install -y nodejs npm git nginx pm2

# Step 5: Exit server (to upload files from local)
exit

# Step 6: Upload project files (run from local machine)
scp -P $SSH_PORT -r . $SERVER_USER@$SERVER_IP:$PROJECT_DIR

# Step 7: Connect back to server
ssh -p $SSH_PORT $SERVER_USER@$SERVER_IP

# Step 8: Setup project
cd $PROJECT_DIR
npm install -g pnpm
pnpm install

# Step 9: Build all packages
pnpm run build

# Step 10: Setup database
cd packages/backend
npx prisma generate
npx prisma db push

# Step 11: Setup Nginx configuration
cat > /etc/nginx/sites-available/win5x << 'EOF'
server {
    listen 80;
    server_name 217.148.142.91;

    # User Panel
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Admin Panel
    location /admin {
        proxy_pass http://127.0.0.1:8081;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # API
    location /api {
        proxy_pass http://127.0.0.1:8082;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Socket.IO
    location /socket.io {
        proxy_pass http://127.0.0.1:8082;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Uploads
    location /uploads {
        proxy_pass http://127.0.0.1:8082;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
EOF

# Step 12: Enable Nginx site
ln -sf /etc/nginx/sites-available/win5x /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default
nginx -t
systemctl reload nginx

# Step 13: Start applications with PM2
cd $PROJECT_DIR
pm2 start ecosystem.config.js

# Step 14: Save PM2 configuration
pm2 save
pm2 startup

# Step 15: Check application status
pm2 status

# Step 16: Setup firewall
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow 8080:8082/tcp
ufw --force enable

# Step 17: Setup log rotation
cat > /etc/logrotate.d/win5x << 'EOF'
/var/www/win5x/logs/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    create 644 root root
    postrotate
        pm2 reloadLogs
    endscript
}
EOF

# ✅ Setup Complete!
# 🌐 Access URLs:
#    User Panel: http://217.148.142.91
#    Admin Panel: http://217.148.142.91/admin
#    Backend API: http://217.148.142.91/api
#
# 📱 Direct Port Access:
#    User Panel: http://217.148.142.91:8080
#    Admin Panel: http://217.148.142.91:8081
#    Backend API: http://217.148.142.91:8082
